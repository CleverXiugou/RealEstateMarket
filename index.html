<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ä¸­å¿ƒåŒ–ä¸åŠ¨äº§ç§Ÿé‡‘æ”¶ç›Šåè®® - RWA Testnet</title>
    <script src="https://cdn.staticfile.org/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdn.staticfile.org/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ================= é…ç½®åŒºåŸŸ =================
        // âš ï¸ è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ éƒ¨ç½²åçš„åˆçº¦åœ°å€
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 
        
        const CONTRACT_ABI = [
            "function listProperty(string _name, string _physicalAddress, uint256 _area, string _propertyType, string _phone) external returns (uint256)",
            "function startInvestment(uint256 _propertyId, uint256 _sharePrice, uint256 _durationMonths) external payable",
            "function finishInvestment(uint256 _propertyId) external",
            "function buyShares(uint256 _propertyId, uint256 _shareAmount) external payable",
            "function listForRent(uint256 _propertyId, uint256 _monthlyRent) external",
            "function rentProperty(uint256 _propertyId, uint256 _months) external payable",
            "function claimRentIncome(uint256 _propertyId) external",
            "function withdrawDeposits(uint256 _propertyId) external",
            "function properties(uint256) view returns (string name, string physicalAddress, uint256 area, string propertyType, string landlordPhone, address landlord, uint8 status, uint256 sharePrice, uint256 investmentEndTime, uint256 landlordDeposit, uint256 totalSharesSold, uint256 monthlyRent, uint256 rentDeposit, uint256 rentStartTime, uint256 rentEndTime, address tenant)",
            "function userInfo(uint256, address) view returns (uint256 shares, uint256 withdrawnRent)",
            "event PropertyListed(uint256 indexed id, string name, address landlord)"
        ];

        const STATUS_MAP = ["é—²ç½® (Idle)", "èèµ„ä¸­ (InInvestment)", "å¾…å‡ºç§Ÿ (InvestLocked)", "å‡ºç§Ÿä¸­ (Rented)"];
        const STATUS_COLOR = ["bg-gray-100 text-gray-800", "bg-blue-100 text-blue-800", "bg-yellow-100 text-yellow-800", "bg-green-100 text-green-800"];

        function App() {
            const [provider, setProvider] = useState(null);
            const [signer, setSigner] = useState(null);
            const [contract, setContract] = useState(null);
            const [account, setAccount] = useState("");
            const [logs, setLogs] = useState([]);
            
            const [searchId, setSearchId] = useState("");
            const [currentProp, setCurrentProp] = useState(null);
            const [userShareInfo, setUserShareInfo] = useState(null);

            const [listForm, setListForm] = useState({ name: "æµ·æ™¯åˆ«å¢… No.1", address: "è¿ˆé˜¿å¯†å¤§é“ 888å·", area: 120, type: "åˆ«å¢…", phone: "13800000000" });
            const [investForm, setInvestForm] = useState({ price: "0.1", duration: 3 });
            const [rentForm, setRentForm] = useState({ rent: "1", months: 4 });
            const [buyShareAmount, setBuyShareAmount] = useState(10);

            async function connectWallet() {
                if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask!");
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const _provider = new ethers.providers.Web3Provider(window.ethereum);
                    const _signer = _provider.getSigner();
                    const _addr = await _signer.getAddress();
                    const _contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, _signer);
                    
                    setProvider(_provider);
                    setSigner(_signer);
                    setAccount(_addr);
                    setContract(_contract);
                    addLog("é’±åŒ…å·²è¿æ¥: " + _addr);
                } catch (err) {
                    console.error(err);
                    addLog("è¿æ¥å¤±è´¥: " + err.message);
                }
            }

            function addLog(msg) {
                setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev]);
            }

            async function handleListProperty() {
                if (!contract) return;
                try {
                    addLog("æ­£åœ¨ä¸Šé“¾æˆ¿äº§ä¿¡æ¯...");
                    const tx = await contract.listProperty(listForm.name, listForm.address, listForm.area, listForm.type, listForm.phone);
                    addLog("äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...");
                    const receipt = await tx.wait();
                    const event = receipt.events.find(e => e.event === "PropertyListed");
                    if (event) {
                        const newId = event.args.id.toString();
                        addLog(`âœ… æˆ¿äº§ä¸Šé“¾æˆåŠŸ! ID: ${newId}`);
                        setSearchId(newId);
                        fetchProperty(newId);
                    }
                } catch (err) {
                    console.error(err);
                    addLog("âŒ ä¸Šé“¾å¤±è´¥: " + err.message);
                }
            }

            async function fetchProperty(idOverride) {
                const idToFetch = idOverride || searchId;
                if (!contract || !idToFetch) return;
                try {
                    addLog(`æ­£åœ¨æŸ¥è¯¢æˆ¿äº§ ID: ${idToFetch}...`);
                    const p = await contract.properties(idToFetch);
                    const u = await contract.userInfo(idToFetch, account);
                    
                    setCurrentProp({
                        id: idToFetch,
                        name: p.name,
                        address: p.physicalAddress,
                        landlord: p.landlord,
                        status: p.status,
                        sharePrice: ethers.utils.formatEther(p.sharePrice),
                        totalSharesSold: p.totalSharesSold.toString(),
                        monthlyRent: ethers.utils.formatEther(p.monthlyRent),
                        rentDeposit: ethers.utils.formatEther(p.rentDeposit),
                        tenant: p.tenant,
                        landlordDeposit: ethers.utils.formatEther(p.landlordDeposit)
                    });

                    setUserShareInfo({
                        shares: u.shares.toString(),
                        withdrawn: ethers.utils.formatEther(u.withdrawnRent)
                    });

                } catch (err) {
                    addLog("âŒ æŸ¥è¯¢å¤±è´¥ (IDå¯èƒ½ä¸å­˜åœ¨): " + err.message);
                    setCurrentProp(null);
                }
            }

            async function handleStartInvest() {
                try {
                    const deposit = ethers.utils.parseEther(investForm.price).mul(30);
                    addLog(`å¼€å¯èèµ„... éœ€æ”¯ä»˜æŠ¼é‡‘: ${ethers.utils.formatEther(deposit)} ETH`);
                    const tx = await contract.startInvestment(currentProp.id, ethers.utils.parseEther(investForm.price), investForm.duration, { value: deposit });
                    await tx.wait();
                    addLog("âœ… èèµ„å·²å¼€å¯");
                    fetchProperty();
                } catch(err) { addLog("âŒ " + err.message); }
            }

            async function handleBuyShares() {
                try {
                    const cost = ethers.utils.parseEther(currentProp.sharePrice).mul(buyShareAmount);
                    addLog(`è´­ä¹° ${buyShareAmount} ä»½... éœ€æ”¯ä»˜: ${ethers.utils.formatEther(cost)} ETH`);
                    const tx = await contract.buyShares(currentProp.id, buyShareAmount, { value: cost });
                    await tx.wait();
                    addLog("âœ… è´­ä¹°æˆåŠŸ");
                    fetchProperty();
                } catch(err) { addLog("âŒ " + err.message); }
            }

            async function handleFinishInvestAndList() {
                try {
                    if (currentProp.status === 1) {
                        addLog("æ­£åœ¨é”å®šèèµ„...");
                        const tx1 = await contract.finishInvestment(currentProp.id);
                        await tx1.wait();
                    }
                    addLog("æ­£åœ¨ä¸Šæ¶å‡ºç§Ÿå¸‚åœº...");
                    const tx2 = await contract.listForRent(currentProp.id, ethers.utils.parseEther(rentForm.rent));
                    await tx2.wait();
                    addLog("âœ… å·²ä¸Šæ¶å‡ºç§Ÿ");
                    fetchProperty();
                } catch(err) { addLog("âŒ " + err.message); }
            }

            async function handleRent() {
                try {
                    const rent = ethers.utils.parseEther(currentProp.monthlyRent).mul(rentForm.months);
                    const deposit = ethers.utils.parseEther(currentProp.rentDeposit);
                    const total = rent.add(deposit);
                    
                    addLog(`æ­£åœ¨ç§Ÿæˆ¿... æ€»éœ€æ”¯ä»˜: ${ethers.utils.formatEther(total)} ETH`);
                    const tx = await contract.rentProperty(currentProp.id, rentForm.months, { value: total });
                    await tx.wait();
                    addLog("âœ… ç§Ÿæˆ¿æˆåŠŸ!");
                    fetchProperty();
                } catch(err) { addLog("âŒ " + err.message); }
            }

            async function handleClaim() {
                try {
                    addLog("æ­£åœ¨æå–æ”¶ç›Š...");
                    const tx = await contract.claimRentIncome(currentProp.id);
                    await tx.wait();
                    addLog("âœ… æ”¶ç›Šæå–æˆåŠŸ");
                    fetchProperty();
                } catch(err) { addLog("âŒ " + err.message); }
            }

            async function handleWithdrawDeposit() {
                try {
                    addLog("æ­£åœ¨ç»“ç®—é€€æŠ¼é‡‘...");
                    const tx = await contract.withdrawDeposits(currentProp.id);
                    await tx.wait();
                    addLog("âœ… ç»“ç®—æˆåŠŸï¼ŒçŠ¶æ€å·²é‡ç½®");
                    fetchProperty();
                } catch(err) { addLog("âŒ " + err.message); }
            }

            return (
                <div className="min-h-screen p-8 text-gray-800">
                    <div className="max-w-6xl mx-auto">
                        
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-indigo-900">RWA ç§Ÿé‡‘æ”¶ç›Šåè®®</h1>
                                <p className="text-gray-500">åŸºäº Foundry æœ¬åœ°æµ‹è¯•ç½‘ (Anvil)</p>
                            </div>
                            <button 
                                onClick={connectWallet}
                                className={`px-6 py-2 rounded-full font-medium transition ${account ? 'bg-green-100 text-green-700' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg'}`}
                            >
                                {account ? `${account.slice(0,6)}...${account.slice(-4)}` : "è¿æ¥é’±åŒ…"}
                            </button>
                        </div>

                        {CONTRACT_ADDRESS === "YOUR_CONTRACT_ADDRESS_HERE" && (
                            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6">
                                <p className="font-bold">âš ï¸ è¯·å…ˆç¼–è¾‘ HTML æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„åˆçº¦åœ°å€ï¼</p>
                            </div>
                        )}

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <div className="space-y-6">
                                <div className="glass-panel p-6 rounded-2xl shadow-sm">
                                    <h2 className="text-xl font-bold mb-4 text-gray-700 border-b pb-2">ğŸ  æˆ¿ä¸œ: ä¸Šé“¾æˆ¿äº§</h2>
                                    <div className="space-y-3">
                                        <input className="w-full p-2 border rounded" placeholder="æˆ¿äº§åç§°" value={listForm.name} onChange={e => setListForm({...listForm, name: e.target.value})} />
                                        <input className="w-full p-2 border rounded" placeholder="ç‰©ç†åœ°å€" value={listForm.address} onChange={e => setListForm({...listForm, address: e.target.value})} />
                                        <div className="flex gap-2">
                                            <input className="w-1/2 p-2 border rounded" type="number" placeholder="é¢ç§¯" value={listForm.area} onChange={e => setListForm({...listForm, area: e.target.value})} />
                                            <input className="w-1/2 p-2 border rounded" placeholder="ç±»å‹" value={listForm.type} onChange={e => setListForm({...listForm, type: e.target.value})} />
                                        </div>
                                        <input className="w-full p-2 border rounded" placeholder="æˆ¿ä¸œç”µè¯" value={listForm.phone} onChange={e => setListForm({...listForm, phone: e.target.value})} />
                                        <button onClick={handleListProperty} className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">ä¸Šé“¾æˆ¿äº§</button>
                                    </div>
                                </div>

                                <div className="glass-panel p-6 rounded-2xl shadow-sm h-64 overflow-y-auto font-mono text-xs bg-gray-900 text-green-400 no-scrollbar">
                                    <h3 className="text-white font-bold mb-2 sticky top-0 bg-gray-900 pb-1 border-b border-gray-700">ğŸ“œ äº¤æ˜“æ—¥å¿—</h3>
                                    {logs.length === 0 && <p className="text-gray-600">æš‚æ— æ´»åŠ¨...</p>}
                                    {logs.map((log, i) => <div key={i} className="mb-1">{log}</div>)}
                                </div>
                            </div>

                            <div className="lg:col-span-2 space-y-6">
                                <div className="glass-panel p-4 rounded-xl shadow-sm flex gap-2">
                                    <input 
                                        className="flex-1 p-2 border rounded text-lg" 
                                        placeholder="è¾“å…¥æˆ¿äº§ ID (æŸ¥çœ‹æ—¥å¿—è·å–)" 
                                        value={searchId}
                                        onChange={e => setSearchId(e.target.value)}
                                    />
                                    <button onClick={() => fetchProperty()} className="bg-gray-800 text-white px-6 rounded hover:bg-gray-900">æŸ¥è¯¢</button>
                                </div>

                                {currentProp ? (
                                    <div className="glass-panel p-8 rounded-2xl shadow-lg border border-indigo-100">
                                        <div className="flex justify-between items-start mb-6">
                                            <div>
                                                <h2 className="text-3xl font-bold text-gray-800">{currentProp.name}</h2>
                                                <p className="text-gray-500 flex items-center mt-1">ğŸ“ {currentProp.address} (ID: {currentProp.id})</p>
                                            </div>
                                            <span className={`px-4 py-1 rounded-full text-sm font-bold ${STATUS_COLOR[currentProp.status]}`}>
                                                {STATUS_MAP[currentProp.status]}
                                            </span>
                                        </div>

                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-sm">
                                            <div className="bg-gray-50 p-3 rounded">
                                                <p className="text-gray-500">æˆ‘çš„ä»½é¢</p>
                                                {/* ä¿®å¤ï¼šä½¿ç”¨ && æ›¿ä»£ ?. */}
                                                <p className="font-bold text-lg text-indigo-600">{(userShareInfo && userShareInfo.shares) || 0}%</p>
                                            </div>
                                            <div className="bg-gray-50 p-3 rounded">
                                                <p className="text-gray-500">å·²æå–æ”¶ç›Š</p>
                                                {/* ä¿®å¤ï¼šä½¿ç”¨ && æ›¿ä»£ ?. */}
                                                <p className="font-bold text-lg">{(userShareInfo && userShareInfo.withdrawn) || 0} ETH</p>
                                            </div>
                                            <div className="bg-gray-50 p-3 rounded">
                                                <p className="text-gray-500">æœˆç§Ÿé‡‘</p>
                                                <p className="font-bold text-lg">{currentProp.monthlyRent > 0 ? currentProp.monthlyRent + " ETH" : "-"}</p>
                                            </div>
                                            <div className="bg-gray-50 p-3 rounded">
                                                <p className="text-gray-500">å·²å”®ä»½é¢</p>
                                                <p className="font-bold text-lg">{currentProp.totalSharesSold}%</p>
                                            </div>
                                        </div>

                                        <div className="border-t pt-6">
                                            <h3 className="font-bold text-gray-700 mb-4">å¯ç”¨æ“ä½œ</h3>
                                            
                                            {currentProp.status === 0 && (
                                                <div className="flex gap-4 items-end bg-blue-50 p-4 rounded-xl">
                                                    <div className="flex-1">
                                                        <label className="text-xs text-gray-500">å•ä»½ä»·æ ¼ (ETH)</label>
                                                        <input className="w-full p-2 border rounded" type="number" value={investForm.price} onChange={e => setInvestForm({...investForm, price: e.target.value})} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <label className="text-xs text-gray-500">æƒç›Šæ—¶é•¿ (æœˆ)</label>
                                                        <input className="w-full p-2 border rounded" type="number" value={investForm.duration} onChange={e => setInvestForm({...investForm, duration: e.target.value})} />
                                                    </div>
                                                    <button onClick={handleStartInvest} className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">å¼€å¯èèµ„</button>
                                                </div>
                                            )}

                                            {currentProp.status === 1 && (
                                                <div className="space-y-4">
                                                    <div className="flex gap-4 items-center bg-blue-50 p-4 rounded-xl border border-blue-100">
                                                        <div className="flex-1">
                                                            <p className="text-sm text-blue-800 font-bold">ğŸ’° æ­£åœ¨èèµ„ (ä»·æ ¼: {currentProp.sharePrice} ETH/ä»½)</p>
                                                            <p className="text-xs text-gray-500">éœ€æ”¯ä»˜ç»™æˆ¿ä¸œï¼Œå‰©ä½™ä»½é¢: {100 - currentProp.totalSharesSold}</p>
                                                        </div>
                                                        <input className="w-20 p-2 border rounded" type="number" value={buyShareAmount} onChange={e => setBuyShareAmount(e.target.value)} />
                                                        <button onClick={handleBuyShares} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">è´­ä¹°ä»½é¢</button>
                                                    </div>

                                                    <div className="bg-yellow-50 p-4 rounded-xl flex justify-between items-center">
                                                        <div className="text-sm">
                                                            <p className="font-bold text-yellow-800">æˆ¿ä¸œæ“ä½œåŒº</p>
                                                            <p className="text-yellow-600">è®¾ç½®æœˆç§Ÿå¹¶è¿›å…¥æ‹›ç§Ÿå¸‚åœº (åŒæ—¶ç»“æŸèèµ„)</p>
                                                        </div>
                                                        <div className="flex gap-2 items-center">
                                                            <input className="w-24 p-2 border rounded" placeholder="æœˆç§ŸETH" value={rentForm.rent} onChange={e => setRentForm({...rentForm, rent: e.target.value})} />
                                                            <button onClick={handleFinishInvestAndList} className="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">ç»“æŸèèµ„å¹¶ä¸Šæ¶å‡ºç§Ÿ</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {currentProp.status === 2 && (
                                                <div className="bg-green-50 p-4 rounded-xl flex justify-between items-center border border-green-200">
                                                    <div>
                                                        <p className="font-bold text-green-800">ğŸ™‹â€â™‚ï¸ æ‹›ç§Ÿä¸­</p>
                                                        <p className="text-sm text-green-600">æœˆç§Ÿ: {currentProp.monthlyRent} ETH | æŠ¼é‡‘: {currentProp.rentDeposit} ETH</p>
                                                    </div>
                                                    <div className="flex gap-2 items-center">
                                                        <span className="text-sm">ç§Ÿ</span>
                                                        <input className="w-16 p-2 border rounded" type="number" value={rentForm.months} onChange={e => setRentForm({...rentForm, months: e.target.value})} />
                                                        <span className="text-sm">ä¸ªæœˆ</span>
                                                        <button onClick={handleRent} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ç¡®è®¤ç§Ÿä¸‹</button>
                                                    </div>
                                                </div>
                                            )}

                                            {currentProp.status === 3 && (
                                                <div className="space-y-4">
                                                    <div className="bg-purple-50 p-4 rounded-xl flex justify-between items-center border border-purple-200">
                                                        <div>
                                                            <p className="font-bold text-purple-800">ğŸ’¸ æ”¶ç›Šæå– (çº¿æ€§é‡Šæ”¾)</p>
                                                            <p className="text-xs text-purple-600">ä»»ä½•äººå‡å¯è°ƒç”¨ï¼Œèµ„é‡‘æŒ‰ä»½é¢åˆ†é…</p>
                                                        </div>
                                                        <button onClick={handleClaim} className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700 shadow">æå–æˆ‘çš„æ”¶ç›Š</button>
                                                    </div>

                                                    <div className="bg-gray-100 p-4 rounded-xl flex justify-between items-center">
                                                        <div>
                                                            <p className="font-bold text-gray-700">ğŸ›‘ ç§Ÿçº¦ç»“æŸ</p>
                                                            <p className="text-xs text-gray-500">ä»…å½“ç§ŸæœŸç»“æŸåå¯æ“ä½œï¼Œé€€è¿˜åŒæ–¹æŠ¼é‡‘</p>
                                                        </div>
                                                        <button onClick={handleWithdrawDeposit} className="bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700">ç»“ç®—å¹¶é€€æŠ¼é‡‘</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="h-64 flex flex-col items-center justify-center text-gray-400 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                                        <p className="text-lg">ğŸ‘ˆ è¯·å…ˆä¸Šæ¶æˆ¿äº§ï¼Œæˆ–è¾“å…¥ ID æŸ¥è¯¢</p>
                                        <p className="text-sm mt-2">æŸ¥çœ‹å·¦ä¾§æ—¥å¿—è·å–æ–°ä¸Šæ¶çš„ ID</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>